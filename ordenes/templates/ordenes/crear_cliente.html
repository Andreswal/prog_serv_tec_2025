{% load crispy_forms_tags %}
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Nuevo Cliente</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      background: #f8f9fa;
    }
    .alert {
      display: none;
      margin-bottom: 15px;
    }
    .alert.show {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h3>âž• Nuevo Cliente</h3>

    <div id="alert-mensaje" class="alert" role="alert"></div>

    <form id="form-nuevo-cliente" method="post" action="{% url 'guardar_cliente' %}">
      {% csrf_token %}
      {{ form.as_p }}
      
      <div class="mt-3">
        <button type="submit" class="btn btn-primary" id="btn-guardar">
          Guardar Cliente
        </button>
        <button type="button" class="btn btn-secondary" onclick="cerrarVentana()">
          Cancelar
        </button>
      </div>
    </form>
  </div>

  <script>
    function mostrarAlerta(mensaje, tipo) {
      const alert = document.getElementById('alert-mensaje');
      if (alert) {
        alert.className = 'alert alert-' + tipo + ' show';
        alert.textContent = mensaje;
      }
    }

    function cerrarVentana() {
      const ventana = document.querySelector('.ventana-flotante');
      if (ventana) {
        ventana.remove();
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      const form = document.getElementById('form-nuevo-cliente');
      if (!form) {
        console.error('Formulario no encontrado');
        return;
      }

      form.addEventListener('submit', async function (e) {
        e.preventDefault();

        const btn = document.getElementById('btn-guardar');
        const originalText = btn ? btn.innerText : null;
        
        if (btn) {
          btn.disabled = true;
          btn.innerText = 'Guardando...';
        }

        const data = new FormData(form);

        try {
          const res = await fetch(form.action, {
            method: 'POST',
            body: data,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          });

          const contentType = res.headers.get('content-type') || '';
          
          if (contentType.includes('application/json')) {
            const json = await res.json();
            
            if (json.ok) {
              console.log('Cliente guardado:', json);
              mostrarAlerta('Cliente guardado correctamente', 'success');
              
              window.postMessage({
                accion: 'cliente_creado',
                cliente_id: json.cliente_id,
                cliente: json
              }, window.location.origin);
              
              if (window.parent !== window) {
                window.parent.postMessage({
                  accion: 'cliente_creado',
                  cliente_id: json.cliente_id,
                  cliente: json
                }, '*');
              }
              
              setTimeout(() => {
                cerrarVentana();
              }, 1000);
              
            } else {
              console.error('Errores:', json.errors || json);
              
              let mensajeError = 'No se pudo guardar el cliente.';
              if (json.errors) {
                mensajeError = Object.entries(json.errors)
                  .map(([campo, errores]) => `${campo}: ${errores.join(', ')}`)
                  .join(' | ');
              }
              
              mostrarAlerta(mensajeError, 'danger');