{% load crispy_forms_tags %}
{% load static %}

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Registrar Orden Completa</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">
  <form method="post" id="form-orden-integrada">
    {% csrf_token %}

    <h1>Registrar Orden Completa</h1>

    <!-- CLIENTE -->
    <h3>Cliente</h3>
    <div class="form-row">
      <div class="col-md-10">
        {{ cliente_form.nombre|as_crispy_field }}
      </div>
      <div class="col-md-2">
        <button type="button" class="btn btn-info w-100" data-toggle="modal" data-target="#clienteModal">
          Buscar Cliente
        </button>
      </div>
    </div>
    {{ cliente_form.telefono|as_crispy_field }}
    {{ cliente_form.email|as_crispy_field }}
    {{ cliente_form.direccion|as_crispy_field }}
    {{ cliente_form.localidad|as_crispy_field }}
    {{ cliente_form.provincia|as_crispy_field }}
    {{ cliente_form.comentarios|as_crispy_field }}

    <hr>

    <!-- EQUIPO -->
    <h3>Equipo</h3>
    {% for field in equipo_form %}
      <div class="form-group">
        {{ field|as_crispy_field }}
      </div>
    {% endfor %}

    <hr>

    <!-- ORDEN -->
    <h3>Orden</h3>
    {% for field in orden_form %}
      <div class="form-group">
        {{ field|as_crispy_field }}
      </div>
    {% endfor %}

    <div class="mt-3">
      <button type="submit" class="btn btn-success">Guardar Orden</button>
    </div>
  </form>

    <!-- Buscar Cliente -->
    <button type="button" class="btn btn-info w-100" onclick="window.parent.postMessage({ abrir: 'clientes' }, '*')">
      Buscar Cliente
    </button>
    
    

  <!-- JS -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    $('#busquedaCliente').on('input', function() {
      const query = $(this).val();
      $.get('/ordenes/buscar-clientes/', { q: query }, function(data) {
        const resultados = data.clientes || [];
        const lista = $('#resultadosCliente');
        lista.empty();

        resultados.forEach(cliente => {
          let equiposHTML = '';
          if (cliente.equipos && cliente.equipos.length > 0) {
            equiposHTML = '<ul class="mt-2 text-muted small">';
            cliente.equipos.forEach(eq => {
              const safeEq = eq.replace(/'/g, "\\'");
              equiposHTML += `<li onclick="autocompletarEquipo('${safeEq}')" style="cursor:pointer;">${safeEq}</li>`;
            });
            equiposHTML += '</ul>';
          }

          lista.append(`
            <li class="list-group-item list-group-item-action" onclick="seleccionarCliente(${cliente.id}, '${cliente.nombre}', '${cliente.telefono}', '${cliente.email}', '${cliente.direccion}', '${cliente.localidad}', '${cliente.provincia}', '${cliente.comentarios}')">
              <strong>${cliente.nombre}</strong> - ${cliente.telefono}
              ${equiposHTML}
            </li>
          `);
        });
      });
    });

    function seleccionarCliente(id, nombre, telefono, email, direccion, localidad, provincia, comentarios) {
      $('[name="cliente-nombre"]').val(nombre);
      $('[name="cliente-telefono"]').val(telefono);
      $('[name="cliente-email"]').val(email);
      $('[name="cliente-direccion"]').val(direccion);
      $('[name="cliente-localidad"]').val(localidad);
      $('[name="cliente-provincia"]').val(provincia);
      $('[name="cliente-comentarios"]').val(comentarios);
      $('#clienteModal').modal('hide');
    }

    function autocompletarEquipo(texto) {
      const partes = texto.split(' (IMEI:');
      const info = partes[0].split(' ');
      $('[name="equipo-tipo"]').val(info[0] || '');
      $('[name="equipo-marca"]').val(info[1] || '');
      $('[name="equipo-modelo"]').val(info.slice(2).join(' ') || '');

      if (partes.length > 1) {
        const resto = partes[1].split(' Serie:');
        const imei = resto[0] ? resto[0].replace(')', '').trim() : '';
        const serie = resto[1] ? resto[1].replace(')', '').trim() : '';
        $('[name="equipo-imei"]').val(imei);
        $('[name="equipo-serie"]').val(serie);
      }
    }

    $(document).on('blur', '[name="equipo-imei"]', function() {
      const imei = $(this).val();
      if (!imei) return;
      $.get('/ordenes/buscar-equipo/', { imei: imei }, function(data) {
        if (data.equipo) {
          $('[name="equipo-tipo"]').val(data.equipo.tipo);
          $('[name="equipo-marca"]').val(data.equipo.marca);
          $('[name="equipo-modelo"]').val(data.equipo.modelo);
          $('[name="equipo-serie"]').val(data.equipo.serie);
        }
      });
    });
  </script>

<script>
  $('#clienteModal').on('shown.bs.modal', function () {
    $('#busquedaCliente').trigger('focus');
  });
</script>

<script src="{% static 'js/ventanas.js' %}"></script>

</body>
</html>
