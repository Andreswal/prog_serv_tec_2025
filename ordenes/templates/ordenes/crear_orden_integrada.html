{% load crispy_forms_tags %}
{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Registrar Orden Completa</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">
    <form method="post" id="form-orden-integrada">
        {% csrf_token %}

        <h1>Registrar Orden Completa</h1>
        
        {% if cliente_seleccionado %}
            <div class="alert alert-success mt-3">
                Cliente Precargado (ID: {{ cliente_seleccionado.id }}): <strong>{{ cliente_seleccionado.nombre }}</strong>.
                Los campos de Cliente están pre-llenados y deshabilitados para proteger su información.
            </div>
        {% endif %}
        <h3>Cliente</h3>
        
        <fieldset {% if cliente_seleccionado %}disabled{% endif %}>
            
            {% if cliente_seleccionado %}
                <input type="hidden" name="cliente-id" value="{{ cliente_seleccionado.id }}">
            {% endif %}

            <div class="form-row">
                <div class="col-md-10">
                    {{ cliente_form.nombre|as_crispy_field }}
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-info w-100" onclick="window.parent.postMessage({ abrir: 'clientes' }, '*')">
                        Buscar Cliente
                    </button>
                </div>
            </div>
            {{ cliente_form.telefono|as_crispy_field }}
            {{ cliente_form.email|as_crispy_field }}
            {{ cliente_form.direccion|as_crispy_field }}
            {{ cliente_form.localidad|as_crispy_field }}
            {{ cliente_form.provincia|as_crispy_field }}
            {{ cliente_form.comentarios|as_crispy_field }}

        </fieldset>
        <hr>

        <h3>Equipo</h3>
        {% for field in equipo_form %}
            <div class="form-group">
                {{ field|as_crispy_field }}
            </div>
        {% endfor %}

        <hr>

        <h3>Orden</h3>
        {% for field in orden_form %}
            <div class="form-group">
                {% if cliente_seleccionado and field.name == 'cliente' %}
                    {{ field.as_hidden }}
                {% else %}
                    {{ field|as_crispy_field }}
                {% endif %}
            </div>
        {% endfor %}

        <div class="mt-3">
            <button type="submit" class="btn btn-success">Guardar Orden</button>
        </div>
    </form>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ... Tu JavaScript de búsqueda de cliente y equipo se mantiene aquí ...
    // Nota: La funcionalidad de seleccionarCliente no se ejecutará si el fieldset está disabled.
    // Esto es deseable, ya que el cliente ya está precargado.
    
    // ... (Mantener todo el JavaScript que pasaste aquí) ...
    
    // Tu función seleccionarCliente
    function seleccionarCliente(id, nombre, telefono, email, direccion, localidad, provincia, comentarios) {
      $('[name="cliente-nombre"]').val(nombre);
      $('[name="cliente-telefono"]').val(telefono);
      $('[name="cliente-email"]').val(email);
      $('[name="cliente-direccion"]').val(direccion);
      $('[name="cliente-localidad"]').val(localidad);
      $('[name="cliente-provincia"]').val(provincia);
      $('[name="cliente-comentarios"]').val(comentarios);
    }
    
    </script>

    <script src="{% static 'js/ventanas.js' %}"></script>
</body>
</html>
