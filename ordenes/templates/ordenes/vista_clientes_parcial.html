
<h3> Lista de Clientes</h3>

<div class="d-flex justify-content-between align-items-center mb-3">
    <form class="form-inline">
        <input type="text" name="q" value="{% if q %}{{ q }}{% endif %}" id="busquedaClienteInput" class="form-control mr-2" placeholder="Buscar por nombre o tel茅fono">
        <button type="button" id="btnBuscarCliente" class="btn btn-primary">Actualizar</button>
    </form>
    
    <div>
        <button type="button" id="btnEliminarSeleccionados" class="btn btn-danger mr-2" disabled>
            Eliminar Seleccionados
        </button>
        <button type="button" class="btn btn-success" onclick="abrirVentana('nuevo-cliente', '/ordenes/clientes/nuevo/')">
            + Nuevo Cliente
        </button>
    </div>
</div>

<table id="tabla-clientes" class="table table-bordered table-hover table-sm">
    <thead class="thead-dark">
        <tr>
            <th><input type="checkbox" id="seleccionarTodos"></th> 
            <th>Nombre</th>
            <th>Tel茅fono</th>
            <th>Email</th>
            <th>Direcci贸n</th>
            <th>Acci贸n</th>
        </tr>
    </thead>
    <tbody>
        {% for cliente in clientes %}
        <tr>
            <td><input type="checkbox" name="cliente_ids" class="cliente-checkbox" value="{{ cliente.id }}"></td>
            <td>{{ cliente.nombre }}</td>
            <td>{{ cliente.telefono }}</td>
            <td>{{ cliente.email }}</td>
            <td>{{ cliente.direccion }}</td>
            <td>
                <button type="button" class="btn btn-sm btn-success mr-1" 
                        onclick="seleccionarClienteParaOrden('{{ cliente.id }}', '{{ cliente.nombre }}')">
                    Nueva Orden
                </button>
                
                <button type="button" class="btn btn-sm btn-info" 
                        onclick="abrirVentana('cliente-{{ cliente.id }}', '{% url 'editar_cliente' cliente_id=cliente.id %}')">
                    Editar
                </button>
            </td>
        </tr>
        {% empty %}
        <tr>
             <td colspan="6" class="text-center text-muted">No hay clientes registrados.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
    // Se mantiene tu l贸gica de b煤squeda aqu铆.
    $('#btnBuscarCliente').on('click', function(e) { 
    e.preventDefault(); 
    const query = $('#busquedaClienteInput').val(); 
    const nuevaUrl = '/ordenes/clientes/parcial/?q=' + encodeURIComponent(query); 
    
    $('#contenido-ventana-clientes').load(nuevaUrl, function(response, status, xhr) {
            if (status == "error") {
                console.error("Error al recargar la b煤squeda AJAX:", xhr.status, xhr.statusText, nuevaUrl); 
            }
        });
    });

    $('#busquedaClienteInput').on('input', function() {
        const filtro = $(this).val().toLowerCase();
        
        $('#tabla-clientes tbody tr').each(function() {
            const texto = $(this).text().toLowerCase();
            $(this).toggle(texto.includes(filtro));
        });
    });
</script>

---

<script>
$(document).ready(function() {
    const $seleccionarTodos = $('#seleccionarTodos');
    const $checkboxes = $('.cliente-checkbox');
    const $btnEliminar = $('#btnEliminarSeleccionados');

    // --- L贸gica de Control de Checkboxes ---
    $seleccionarTodos.on('change', function() {
        $checkboxes.prop('checked', this.checked);
        $btnEliminar.prop('disabled', !this.checked);
    });

    $checkboxes.on('change', function() {
        const checkedCount = $checkboxes.filter(':checked').length;
        $btnEliminar.prop('disabled', checkedCount === 0);
        
        // Sincronizar 'Seleccionar Todos'
        if (!this.checked) {
            $seleccionarTodos.prop('checked', false);
        } else if (checkedCount === $checkboxes.length) {
            $seleccionarTodos.prop('checked', true);
        }
    });

    // --- L贸gica de Eliminaci贸n por AJAX ---
    $btnEliminar.on('click', function() {
        const clienteIds = $checkboxes.filter(':checked').map(function() {
            return $(this).val();
        }).get();

        if (!confirm(`驴Est谩s seguro de que quieres eliminar ${clienteIds.length} cliente(s) seleccionado(s)?`)) {
            return;
        }

        $.ajax({
            url: '{% url "eliminar_clientes_ajax" %}', 
            type: 'POST',
            data: {
                // Importante: la clave debe terminar en '[]' para enviar un array
                'cliente_ids[]': clienteIds, 
                'csrfmiddlewaretoken': '{{ csrf_token }}' 
            },
            success: function(response) {
                if (response.success) {
                    // Recarga la lista de clientes para mostrar los cambios
                    $('#contenido-ventana-clientes').load('/clientes/parcial/', function() {
                        alert(`Eliminaci贸n exitosa de ${response.count} cliente(s).`);
                    });
                }
            },
            error: function() {
                alert("Ocurri贸 un error al intentar eliminar los clientes. Revisa la consola.");
            }
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
 window.addEventListener('message', function(e) {
  if (e.data && e.data.accion === 'cliente_creado') {
   // Recargar la lista de clientes dentro de la ventana actual
   fetch('/ordenes/clientes/parcial/')
        .then(res => res.text())
    .then(html => {
     const cont = document.querySelector('#tabla-clientes').parentElement;
     cont.innerHTML = html;
     // volver a inicializar buscador
     if (window.clientesInit) window.clientesInit(cont);
    });
  }
 });
});
</script>


<script>
    /**
     * Cierra la ventana de lista de clientes y abre la ventana para una nueva orden.
     * @param {number} clienteId El ID del cliente seleccionado.
     * @param {string} clienteNombre El nombre del cliente (opcional, para consola).
     */
    function seleccionarClienteParaOrden(clienteId, clienteNombre) {
        // 1. CERRAR la ventana actual (Lista de Clientes)
        // Asumimos que el ID de la ventana de clientes es 'ventana-clientes'
        const ventanaClientes = document.getElementById('ventana-clientes');
        if (ventanaClientes) {
            ventanaClientes.remove();
        }
        
        // 2. ABRIR la ventana para la nueva orden
        // La URL lleva el ID del cliente como par谩metro GET: /ordenes/nueva/?cliente_id=X
        const urlOrden = '{% url 'crear_orden_view' %}?cliente_id=' + clienteId;

        
        // El ID de la nueva ventana ser谩 'form-orden-cliente-X'
        const urlOrden = '{% url 'crear_orden_integrada_precargada' %}?cliente_id=' + clienteId; 
        
        abrirVentana(idVentanaOrden, urlOrden);
        
        console.log(`Cliente ${clienteId} (${clienteNombre}) seleccionado para nueva orden.`);
    }
    </script>